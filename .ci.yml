image: $CI_REGISTRY_IMAGE:rdfm-ci-base-bookworm

.common_only: &common_only
  only:
    - main
    - merge_requests

variables:
  SSL_CERT_DIR: "certs"
  PIP_CACHE_DIR: $CI_PROJECT_DIR/.cache/pip
  GOROOT: ""
  SCALENODE_CPU: 2
  SCALENODE_RAM: 2048
  SCALENODE_DISK: 20
  SCALENODE_KERNEL: legacy

.build-base:
  variables:
    JWT_SECRET: testsecret123123123
    POSTGRES_MAJOR_VERSION: 15
  before_script:
    - python -V
    - (apt update &&
        apt-get -y install make netcat-openbsd openssl telnet uuid-runtime xxd redis-server postgresql-$POSTGRES_MAJOR_VERSION postgresql-contrib cmake &&
        service postgresql start &&
        ln -s /usr/lib/postgresql/$POSTGRES_MAJOR_VERSION/bin/initdb /bin/initdb &&
        ln -s /usr/lib/postgresql/$POSTGRES_MAJOR_VERSION/bin/postgres /bin/postgres)
    - git clone https://github.com/antmicro/go-xdelta xdelta
    - cd xdelta
    - cmake -B build/ -DCGO_INTEGRATION=ON -DENCODER=ON
    - cmake --build build/
    - cmake --install build/
    - cd ../
    - (cd server && poetry build && poetry install)
    - (cd manager && poetry build && poetry install)
    - server/tests/certgen.sh certs IP.1:127.0.0.1 DEVICE no

.build:
  <<: *common_only
  extends: .build-base

.go-pb-release: &go-pb-release
  variables:
    GO_REL: https://go.dev/dl/go1.22.3.linux-amd64.tar.gz
    PB_REL: https://github.com/protocolbuffers/protobuf/releases/download/v31.1/protoc-31.1-linux-x86_64.zip
    PROTOC_GO_REL: google.golang.org/protobuf/cmd/protoc-gen-go@v1.36.6

.install-xdelta:
  before_script:
    - apt-get update
    - apt-get install -y cmake
    - git clone https://github.com/antmicro/go-xdelta xdelta
    - cd xdelta
    - cmake -B build/ -DENCODER=ON -DCGO_INTEGRATION=ON
    - cmake --build build/
    - cmake --install build/
    - cd ../

.install-poetry-and-lint-tools:
  # rdfm-ci-base-bookworm has an outdated version of poetry
  # changes to pyproject.toml spec require a newer version (PEP 621, poetry 2.0+ required)
  image: python:3.11.4-bookworm
  before_get_sources:
    - pip3 install poetry
    - pip3 install --upgrade pip
    - apt update && apt-get install -y pipx
  before_script:
    - (cd tools/rdfm-lint-scripts && pipx install .)

.mypy-check-base:
  extends: .install-poetry-and-lint-tools
  variables:
    TARGET: "" # fill this when extending
    ARGS:   "" # additional arguments for mypy, can be left empty
  stage: static-checks
  script:
    - export PATH=$HOME/.local/bin:$PATH
    - cd $TARGET && poetry install
    - rdfm-lint-mypy $ARGS
  allow_failure: true

.install-poetry-and-apptainer:
  image: python:3.11.4-bookworm
  variables:
    APPTAINER_REL: v1.4.3
    GO_REL: https://go.dev/dl/go1.24.4.linux-amd64.tar.gz
    SCALENODE_RAM: 4096
  before_script:
    - pip3 install poetry
    - pip3 install --upgrade pip
    - (apt update &&
        apt-get -y install build-essential libseccomp-dev uidmap fakeroot cryptsetup tzdata dh-apparmor squashfs-tools curl wget git pipx iptables kcat openjdk-17-jre)
    - wget --quiet -O - $GO_REL | tar xz
    - git clone https://github.com/apptainer/apptainer.git
    - export PATH=`pwd`/go/bin:$PATH
    - cd apptainer
    - git checkout ${APPTAINER_REL}
    - ./mconfig
    - cd builddir
    - mkdir tmp
    - export GOTMPDIR=$(pwd)/tmp
    - make
    - make install
    - rm -rf ./tmp

stages:
  - docs-build
  - docs-deploy
  - build
  - static-checks
  - local-tests

python-pycodestyle-check:
  extends: .install-poetry-and-lint-tools
  stage: static-checks
  script:
    - export PATH=$HOME/.local/bin:$PATH
    - (cd server && rdfm-lint-pycodestyle)
    - (cd manager && rdfm-lint-pycodestyle)
    - (cd common/communication && rdfm-lint-pycodestyle)
    - (cd tools/rdfm-plotter && rdfm-lint-pycodestyle --exclude log_pb2.py)

python-mypy-check-manager:
  extends: .mypy-check-base
  variables:
    TARGET: manager

python-mypy-check-server:
  extends: .mypy-check-base
  variables:
    TARGET: server
    ARGS: "--config-file ./mypy.ini"

python-mypy-check-common-communication:
  extends: .mypy-check-base
  variables:
    TARGET: common/communication

python-mypy-check-plotter:
  extends: .mypy-check-base
  variables:
    TARGET: tools/rdfm-plotter

test-package-api:
  extends: .build
  stage: local-tests
  script:
    - cd server
    - poetry run pytest tests/test-packages.py

test-group-api:
  extends: .build
  stage: local-tests
  script:
    - cd server
    - poetry run pytest tests/test-groups.py

test-server-update-policies:
  extends: .build
  stage: local-tests
  script:
    - cd server
    - poetry run pytest tests/test-update-policies.py --sqlite
    - poetry run pytest tests/test-update-policies.py --postgres

test-server-update-resolver:
  extends: .build
  stage: local-tests
  script:
    - cd server
    - poetry run pytest tests/test-update-resolver.py

test-server-update-api:
  extends: .build
  stage: local-tests
  script:
    - cd server
    - poetry run pytest tests/test-update-checker.py --sqlite
    - poetry run pytest tests/test-update-checker.py --postgres

test-server-device-auth-api:
  extends: .build
  stage: local-tests
  variables:
    SCALENODE_RAM: 4096
  script:
    - cd server
    - poetry run pytest tests/test-server-auth.py --sqlite
    - poetry run pytest tests/test-server-auth.py --postgres

test-server-s3-storage:
  extends: .build
  stage: local-tests
  script:
    - cd server
    - poetry run pytest tests/test-server-s3-storage.py

test-server-management-auth:
  extends: .build
  stage: local-tests
  variables:
    SCALENODE_RAM: 4096
  script:
    - cd server
    - poetry run pytest tests/test-server-management-auth.py --sqlite
    - poetry run pytest tests/test-server-management-auth.py --postgres

test-package-upload-auth:
  extends: .build
  stage: local-tests
  variables:
    SCALENODE_RAM: 4096
  script:
    - cd server
    - poetry run pytest tests/test-package-upload-auth.py --sqlite
    - poetry run pytest tests/test-package-upload-auth.py --postgres

test-server-route-correctness:
  extends: .build
  stage: local-tests
  script:
    - cd server
    - poetry run pytest tests/test-server-route-correctness.py

test-server-websocket:
  extends: .build
  stage: local-tests
  script:
    - cd server
    - poetry run pytest tests/test-server-ws.py --sqlite
    - poetry run pytest tests/test-server-ws.py --postgres

test-manager:
  extends: .build
  stage: local-tests
  variables:
    SCALENODE_RAM: 4096
  script:
    - cd server
    - poetry run pytest tests/test-manager.py --sqlite
    - poetry run pytest tests/test-manager.py --postgres

test-server-stress:
  extends: .build
  stage: local-tests
  variables:
    SCALENODE_CPU: 8
    SCALENODE_RAM: 32768
  script:
    - cd server
    - poetry run pytest tests/test-stress.py -vs
  artifacts:
    paths:
      - server/tests/logs/*
    when: always
  only:
    - schedules

test-server-logs:
  extends: .build
  stage: local-tests
  script:
    - cd server
    - poetry run pytest tests/test-server-logs.py --sqlite
    - poetry run pytest tests/test-server-logs.py --postgres

test-server-file-download:
  extends: .build
  stage: local-tests
  script:
    - cd server
    - poetry run pytest tests/test-file-download.py  --sqlite
    - poetry run pytest tests/test-file-download.py  --postgres

test-actions:
  extends: .build
  stage: local-tests
  script:
    - cd server
    - poetry run pytest tests/test-actions.py  --sqlite
    - poetry run pytest tests/test-actions.py  --postgres

test-server-side-events:
  extends: .build
  stage: local-tests
  script:
    - cd server
    - poetry run pytest tests/test-server-side-events.py  --sqlite
    - poetry run pytest tests/test-server-side-events.py  --postgres
  artifacts:
    paths:
      - server/tests/server_gunicorn.log
      - server/tests/server_redis.log
    when: always

test-server-pubsub-acl-handling:
  extends: .build
  stage: local-tests
  script:
    - cd server
    - poetry run pytest tests/test-pubsub-acl-handling.py

# ===== rdfm-client ===== #

build-rdfm-client:
  stage: build
  <<: *go-pb-release
  extends: .install-xdelta
  script:
    # Currently CI ships Go 1.19, while the client needs 1.20+
    - wget --quiet -O - $GO_REL | tar xz
    - wget --quiet $PB_REL
    - unzip $(basename $PB_REL) -d protoc
    - export PATH=`pwd`/go/bin:$PATH
    - export PATH=`pwd`/protoc/bin:$PATH
    - export GOBIN=`pwd`/go/bin
    - go install $PROTOC_GO_REL
    - cd devices/linux-client
    - make

build-rdfm-logging-tool:
  stage: build
  script:
    - cd tools/loggers
    - make

test-rdfm-client:
  stage: local-tests
  <<: *common_only
  <<: *go-pb-release
  dependencies:
    - build-rdfm-artifact
  extends: .install-xdelta
  script:
    # Install rdfm-artifact, which is required for the tests
    - mv tools/rdfm-artifact/rdfm-artifact /usr/bin/
    - wget --quiet -O - $GO_REL | tar xz
    - wget --quiet $PB_REL
    - unzip $(basename $PB_REL) -d protoc
    - export PATH=`pwd`/go/bin:$PATH
    - export PATH=`pwd`/protoc/bin:$PATH
    - export GOBIN=`pwd`/go/bin
    - go install $PROTOC_GO_REL
    - cd devices/linux-client
    - make generate
    - make test

test-rdfm-client-docker:
  stage: local-tests
  <<: *common_only
  dependencies:
    - build-rdfm-artifact
  extends: .install-xdelta
  script:
    # Currently CI ships Go 1.19, while the client needs 1.20+
    - wget --quiet -O - "https://go.dev/dl/go1.22.3.linux-amd64.tar.gz" | tar xz
    - export PATH=`pwd`/go/bin:$PATH
    # Install rdfm-artifact, which is required for the tests
    - mv tools/rdfm-artifact/rdfm-artifact /usr/bin/
    # The tests are running in a Docker container, install and set up
    # the Docker daemon
    - cd devices/linux-client
    - apt update
    - apt -qq -y --no-install-recommends install docker.io cgroupfs-mount crun fuse-overlayfs pigz ca-certificates
    - cgroupfs-mount
    - ../../common/docker/start-docker.sh
    # HACK: For CI runs, we have to replace the -it flag in docker run
    #       as this is not a real terminal.
    # HACK: We also comment out git invocations, as only a subfolder is mounted
    #       in the container, which would cause that call to fail. This is fine,
    #       as the invocation is only required when container UID != source UID
    #       (i.e, not in CI runs, where we run everything as root).
    - sed -i "s/\-it//g" ./scripts/test-docker/test-artifact-info.sh
    - sed -i "s/git/#git/g" ./scripts/test-docker/data/check-artifact-info.sh
    - sed -i "s/\-it//g" ./scripts/test-docker/test-deltas.sh
    - sed -i "s/git/#git/g" ./scripts/test-docker/data/check-delta-patching.sh
    - sed -i "s/\-it//g" ./scripts/test-docker/test-delta-over-http.sh
    # Run rdfm-client Docker tests
    - ./scripts/test-docker/test-artifact-info.sh
    - cd scripts/test-docker/
    - ./make-delta-samples.sh
    - cd ../../
    - ./scripts/test-docker/test-deltas.sh
    - ./scripts/test-docker/test-delta-over-http.sh

# ===== rdfm-mcumgr-client ===== #

build-mcumgr-client:
  stage: build
  before_script:
    # Currently CI ships Go 1.19, while the client needs 1.22+
    - wget --quiet -O - "https://go.dev/dl/go1.22.3.linux-amd64.tar.gz" | tar xz
  script:
    - export PATH=`pwd`/go/bin:$PATH
    - make -C devices/mcumgr-client
  artifacts:
    expire_in: 1 day
    paths:
      - devices/mcumgr-client/rdfm-mcumgr-client

build-mcumgr-test-samples:
  variables:
    SCALENODE_CPU: 4
    SCALENODE_RAM: 8192
    ZEPHYR_WORKSPACE: $CI_PROJECT_DIR/zephyr
    ZEPHYR_BASE: $CI_PROJECT_DIR/zephyr/zephyr
    ZEPHYR_SDK_INSTALL_DIR: $CI_PROJECT_DIR/zephyr/sdk
  <<: *common_only
  stage: build
  before_script:
    - apt update
    - apt -qqy --no-install-recommends install cmake device-tree-compiler ninja-build
  script:
    - ./devices/mcumgr-client/tests/build/build_samples.sh
    - ls -la ./devices/mcumgr-client/tests/out/
  artifacts:
    expire_in: 1 day
    paths:
      - devices/mcumgr-client/tests/out

test-mcumgr-client:
  variables:
    SCALENODE_CPU: 4
    SCALENODE_RAM: 6144
    SCALENODE_DISK: 10
  <<: *common_only
  dependencies:
    - build-mcumgr-client
    - build-mcumgr-test-samples
    - build-rdfm-artifact
  stage: local-tests
  script:
    - set -eo pipefail
    - apt update && apt -qqy --no-install-recommends install iproute2 git-lfs >/dev/null
    # NOTE: Currently Renode is tracked using LFS since we're using a custom
    #       build with support for both STM32F764 and NRF52840 flash controllers.
    #       If they get added into main, this can be replaced with official release
    #       `wget --quiet https://builds.renode.io/renode_1.X.Y_amd64.deb`
    - git lfs pull && apt -qqy --no-install-recommends install ./devices/mcumgr-client/tests/prebuilt/renode*.deb >/dev/null
    - mv tools/rdfm-artifact/rdfm-artifact /usr/bin/
    - mv devices/mcumgr-client/rdfm-mcumgr-client /usr/bin/
    - pushd server && pip3 install -e . && popd
    - pushd manager && pip3 install -e . && popd
    - cd devices/mcumgr-client
    # Run the test
    - ./tests/end2end/test.sh

# ===== rdfm-artifact ===== #

build-rdfm-artifact:
  stage: build
  extends: .install-xdelta
  script:
    # Currently CI ships Go 1.19, while the rdfm-artifact needs 1.20+
    - wget --quiet -O - "https://go.dev/dl/go1.22.3.linux-amd64.tar.gz" | tar xz
    - export PATH=`pwd`/go/bin:$PATH
    - cd tools/rdfm-artifact
    - make
  artifacts:
    paths:
      - tools/rdfm-artifact/rdfm-artifact

test-rdfm-artifact:
  <<: *common_only
  stage: local-tests
  extends: .install-xdelta
  script:
    # Currently CI ships Go 1.19, while the rdfm-artifact needs 1.20+
    - wget --quiet -O - "https://go.dev/dl/go1.22.3.linux-amd64.tar.gz" | tar xz
    - export PATH=`pwd`/go/bin:$PATH
    - cd tools/rdfm-artifact
    - make test

# ===== rdfm-jwt-auth ===== #

build-rdfm-jwt-auth:
  image: maven:3.9.11-eclipse-temurin-17
  stage: build
  script:
    - cd server/deploy/pubsub-demo/rdfm-jwt-auth
    - mvn package
  artifacts:
    paths:
      - server/deploy/pubsub-demo/rdfm-jwt-auth/target/rdfm-jwt-auth-*.jar

# ===== rdfm-plotter ===== #

test-rdfm-plotter:
  <<: *common_only
  stage: local-tests
  extends: .install-poetry-and-apptainer
  dependencies:
    - build-rdfm-jwt-auth
  script:
    - mv server/deploy/pubsub-demo/rdfm-jwt-auth/target/rdfm-jwt-auth-*.jar tools/rdfm-plotter/tests
    - cd tools/rdfm-plotter/tests
    - mkdir tmp
    - APPTAINER_TMPDIR=$(pwd)/tmp apptainer -v build test_kafka.sif test_kafka.def
    - rm -rf ./tmp
    - cd ..
    - poetry install
    - poetry run pytest tests/test-plotter.py -s -v --testpath $(pwd)/tests
    - poetry run pytest tests/test-rdfm-jwt-auth.py -s -v --testpath $(pwd)/tests

# ===== rdfm-frontend ===== #

build-rdfm-frontend:
  image: node:20
  stage: static-checks
  <<: *common_only
  script:
    - cd frontend
    - npm install
    - npm run format-check
    - npm run build
  artifacts:
    paths:
      - frontend/dist

# ===== documentation ===== #

docs-build:
  stage: docs-build
  <<: *common_only
  before_script:
    # Disable venvs and just install everything globally
    # The server module must be accessible by Sphinx to
    # properly autogenerate API documentation
    - poetry config virtualenvs.create false
    # Install doc building requirements
    - pip3 install -r documentation/requirements.txt
    # Build and install the server
    - (cd server/ && poetry build --verbose && poetry install --verbose && pip3 install --verbose -e .)
  script:
    - cd documentation/
    - make html latexpdf
    - cp build/latex/*.pdf build/html/
    # Make sure the docs archive lands in the root of the repository
    - tar cf ../$CI_DOCS_ARCHIVE -C build/html/ .
  artifacts:
    paths:
      - documentation/build
      - $CI_DOCS_ARCHIVE

docs-deploy:
  variables:
    GIT_STRATEGY: none
  <<: *common_only
  dependencies:
    - docs-build
  stage: docs-deploy
  tags: ["docs"]
  script: echo 'Deploying docs'
  artifacts:
    paths:
      - $CI_DOCS_ARCHIVE
